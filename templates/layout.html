<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <!-- http://getbootstrap.com/docs/5.3/ -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <!-- https://favicon.io/emoji-favicons/money-bag/ -->
    <link href="/static/favicon.ico" rel="icon" />

    <link href="/static/styles.css" rel="stylesheet" />
    <link href="/static/sell.css" rel="stylesheet" />

    <title>Finance: {% block title %}{% endblock %}</title>

    <!-- Inline script to prevent dark mode flash - CRITICAL: Must be in head -->
    <script>
      (function() {
        const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
        if (isDarkMode) {
          document.documentElement.classList.add('dark-mode');
        }
      })();
    </script>
  </head>

  <body>
    <!-- Immediate dark mode application script -->
    <script>
      (function() {
        const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
        if (isDarkMode) {
          document.body.classList.add('dark-mode');
        }
      })();
    </script>

    <nav
      id="navbar-main"
      class="border navbar navbar-expand-md"
    >
      <!-- Apply navbar classes immediately based on dark mode preference -->
      <script>
        (function() {
          const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
          const navbar = document.getElementById('navbar-main');
          
          if (isDarkMode) {
            navbar.className = navbar.className.replace('bg-light navbar-light', 'bg-dark navbar-dark');
            navbar.classList.add('bg-dark', 'navbar-dark');
          } else {
            navbar.classList.add('bg-light', 'navbar-light');
          }
        })();
      </script>

      <div class="container-fluid">
        <a class="navbar-brand" href="/"><span class="red">Finance</span></a>
        <button
          aria-controls="navbar"
          aria-expanded="false"
          aria-label="Toggle navigation"
          class="navbar-toggler"
          data-bs-target="#navbar"
          data-bs-toggle="collapse"
          type="button"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbar">
          {% if session["user_id"] %}
          <ul class="navbar-nav me-auto mt-2">
            <li class="nav-item">
              <a class="nav-link" href="/quote">Quote</a>
            </li>
            <li class="nav-item"><a class="nav-link" href="/buy">Buy</a></li>
            <li class="nav-item"><a class="nav-link" href="/sell">Sell</a></li>
            <li class="nav-item">
              <a class="nav-link" href="/history">History</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/change-password">Change Password</a>
            </li>
            <li class="nav-item">
              <a href="/delete" class="nav-link dropdown-item text-danger"
                >Delete Account</a
              >
            </li>
            <li class="nav-item">
              <a href="/2fa/setup" class="btn nav-link btn-warning"
                >Enable 2FA</a
              >
            </li>
          </ul>
          <ul class="navbar-nav ms-auto mt-2">
            <li class="nav-item">
              <a class="nav-link" href="/logout">Log Out</a>
            </li>
            <!-- Dark mode toggle button -->
            <li class="nav-item ms-2">
              <button class="btn btn-outline-secondary" id="darkModeToggle">
                🌙
              </button>
            </li>
          </ul>
          {% else %}
          <ul class="navbar-nav ms-auto mt-2">
            <li class="nav-item">
              <a class="nav-link" href="/register">Register</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/login">Log In</a>
            </li>
            <li class="nav-item ms-2">
              <button class="btn btn-outline-secondary" id="darkModeToggle">
                🌙
              </button>
            </li>
          </ul>
          {% endif %}
        </div>
      </div>
    </nav>

    {% if get_flashed_messages() %}
    <header>
      <div class="alert alert-primary mb-0 text-center" role="alert">
        {{ get_flashed_messages() | join(" ") }}
      </div>
    </header>
    {% endif %}

    <main class="container py-5 text-center">
      {% block main %}{% endblock %}
    </main>

    <footer class="mb-5">
      <form
        action="https://validator.w3.org/check"
        class="text-center"
        enctype="multipart/form-data"
        method="post"
        target="_blank"
      >
        <input name="doctype" type="hidden" value="HTML5" />
        <input name="fragment" type="hidden" />
        <input
          alt="Validate"
          src="/static/I_heart_validator.png"
          type="image"
        />
        <!-- https://validator.w3.org/ -->
      </form>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const toggleBtn = document.getElementById("darkModeToggle");
          const navbar = document.getElementById("navbar-main");
          const body = document.body;

          // Function to enable dark mode
          function enableDarkMode() {
            document.documentElement.classList.add("dark-mode");
            body.classList.add("dark-mode");
            navbar.classList.remove("navbar-light", "bg-light");
            navbar.classList.add("navbar-dark", "bg-dark");
            toggleBtn.textContent = "☀️";
            localStorage.setItem("darkMode", "enabled");
          }

          // Function to disable dark mode
          function disableDarkMode() {
            document.documentElement.classList.remove("dark-mode");
            body.classList.remove("dark-mode");
            navbar.classList.remove("navbar-dark", "bg-dark");
            navbar.classList.add("navbar-light", "bg-light");
            toggleBtn.textContent = "🌙";
            localStorage.setItem("darkMode", "disabled");
          }

          // Apply saved preference on load and sync button state
          const darkModePreference = localStorage.getItem("darkMode");
          if (darkModePreference === "enabled") {
            // Dark mode should already be applied by inline scripts
            // Just sync the button state - navbar should already be correct
            toggleBtn.textContent = "☀️";
          } else {
            // Ensure light mode button state
            toggleBtn.textContent = "🌙";
          }

          // Toggle dark mode on button click
          toggleBtn.addEventListener("click", () => {
            if (body.classList.contains("dark-mode")) {
              disableDarkMode();
            } else {
              enableDarkMode();
            }
          });

          // Validator form setup
          const html =
            "<!DOCTYPE " +
            document.doctype.name +
            (document.doctype.publicId
              ? ' PUBLIC "' + document.doctype.publicId + '"'
              : "") +
            (!document.doctype.publicId && document.doctype.systemId
              ? " SYSTEM"
              : "") +
            (document.doctype.systemId
              ? ' "' + document.doctype.systemId + '"'
              : "") +
            ">\n" +
            document.documentElement.outerHTML;

          const fragmentInput = document.querySelector(
            'form[action="https://validator.w3.org/check"] > input[name="fragment"]'
          );
          
          if (fragmentInput) {
            fragmentInput.value = html;
          }
        });

        // Password toggle function
        function togglePassword() {
          const password = document.getElementById("password");
          const confirm = document.getElementById("confirmation");

          if (password && confirm) {
            const type = password.type === "password" ? "text" : "password";
            password.type = type;
            confirm.type = type;
          }
        }
      </script>
    </footer>
  </body>
</html>